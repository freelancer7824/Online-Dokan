<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings</title>
  <style>
  .settings-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .settings-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
  }

  .settings-title {
    font-size: 24px;
    color: #2c3e50;
    margin: 0;
  }

  .settings-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    border-bottom: 1px solid #ddd;
    margin-bottom: 20px;
  }

  .tab-btn {
    padding: 10px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: #555;
    border-bottom: 3px solid transparent;
    white-space: nowrap;
  }

  .tab-btn.active {
    color: #3498db;
    border-bottom-color: #3498db;
    font-weight: 600;
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .form-group { margin-bottom: 20px; }
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
  }

  .save-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }

  .save-btn:hover { background: #2980b9; }

  .message {
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 20px;
    text-align: center;
    display: none;
  }

  .success { background: #d4edda; color: #155724; }
  .error { background: #f8d7da; color: #721c24; }
  .small { font-size: 13px; color: #6b7280; margin-top: 4px; }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    .settings-container {
      padding: 15px;
      border-radius: 0;
    }
    .settings-title { font-size: 20px; }
    .tab-btn {
      font-size: 14px;
      padding: 8px 10px;
      flex: 1 1 auto;
      text-align: center;
    }
    .form-group input,
    .form-group select {
      font-size: 14px;
      padding: 8px;
    }
    .save-btn {
      font-size: 14px;
      padding: 10px 15px;
      width: 100%;
    }
  }
</style>
</head>
<body>
  <div class="settings-container">
    <div class="settings-header">
      <h1 class="settings-title">Settings</h1>
    </div>
    
    <div class="settings-tabs">
      <button class="tab-btn active" onclick="openTab('profile')">Profile</button>
      <button class="tab-btn" onclick="openTab('security')">Security</button>
      <button class="tab-btn" onclick="openTab('preferences')">Preferences</button>
      <button class="tab-btn" onclick="openTab('customer-access')">Customer Access</button>
    </div>
    
    <div id="profile" class="tab-content active">
      <div id="profileMessage" class="message"></div>
      
      <div class="form-group">
        <label for="shopName">Shop Name</label>
        <input type="text" id="shopName" placeholder="Enter your shop name">
      </div>
      
      <div class="form-group">
        <label for="einNumber">EIN Number</label>
        <input type="text" id="einNumber" placeholder="Enter your EIN number">
      </div>
      
      <button class="save-btn" onclick="saveProfile()">Save Changes</button>
    </div>
    
    <div id="security" class="tab-content">
      <div id="securityMessage" class="message"></div>
      
      <div class="form-group">
        <label for="currentPassword">Current Password</label>
        <input type="password" id="currentPassword" placeholder="Enter current password">
      </div>
      
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">Confirm New Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password">
      </div>
      
      <button class="save-btn" onclick="changePassword()">Change Password</button>
    </div>
    
    <div id="preferences" class="tab-content">
      <div id="preferencesMessage" class="message"></div>
      
      <div class="form-group">
        <label for="language">Language</label>
        <select id="language">
          <option value="en">English</option>
          <option value="bn">Bengali</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="BDT">Bangladeshi Taka (à§³)</option>
          <option value="USD">US Dollar ($)</option>
        </select>
      </div>
      
      <button class="save-btn" onclick="savePreferences()">Save Preferences</button>
    </div>
    
    <div id="customer-access" class="tab-content">
      <div id="customerAccessMessage" class="message"></div>
      
      <div class="form-group">
        <label for="shopEmei">Shop EMEI</label>
        <input type="text" id="shopEmei" placeholder="Enter your shop EMEI number">
        <div class="small">This EMEI number will be used by customers to login to their notice board.</div>
      </div>
      
      <div class="form-group">
        <label for="generateEmei">Generate New EMEI</label>
        <button id="generateEmei" class="save-btn" onclick="generateNewEmei()" style="width: auto;">Generate</button>
        <div class="small">Generate a new random EMEI if you suspect your current one is compromised.</div>
      </div>
      
      <button class="save-btn" onclick="saveCustomerAccessSettings()">Save Settings</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2eI8wHpjQsd-jOuEvIfW_Om2DnxUixHI",
      authDomain: "inc-project-65096.firebaseapp.com",
      databaseURL: "https://inc-project-65096-default-rtdb.firebaseio.com",
      projectId: "inc-project-65096",
      storageBucket: "inc-project-65096.appspot.com",
      messagingSenderId: "164350074126",
      appId: "1:164350074126:web:28144737a66cb8055f8b5f",
      measurementId: "G-EBPRH80411"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../auth/login_signup.html";
        return;
      }

      const uid = user.uid;
      
      // Load user data
      const userRef = ref(db, `users/${uid}`);
      const userSnap = await get(userRef);
      
      if (userSnap.exists()) {
        const userData = userSnap.val();
        document.getElementById("shopName").value = userData.dokan_name || "";
        document.getElementById("einNumber").value = userData.dokan_ein || "";
        document.getElementById("shopEmei").value = userData.shop_emei || "";
        
        // Load preferences if they exist
        if (userData.preferences) {
          document.getElementById("language").value = userData.preferences.language || "en";
          document.getElementById("currency").value = userData.preferences.currency || "BDT";
        }
      }
    });
    
    window.openTab = function(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Activate the selected tab
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[onclick="openTab('${tabId}')"]`).classList.add('active');
    };
    
    window.saveProfile = async function() {
      const shopName = document.getElementById("shopName").value.trim();
      const einNumber = document.getElementById("einNumber").value.trim();
      const message = document.getElementById("profileMessage");
      
      if (!shopName) {
        showMessage(message, "Shop name is required", "error");
        return;
      }
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const updates = {
              dokan_name: shopName,
              dokan_ein: einNumber
            };
            
            await update(ref(db, `users/${user.uid}`), updates);
            showMessage(message, "Profile updated successfully", "success");
          } catch (error) {
            console.error("Error updating profile:", error);
            showMessage(message, "Failed to update profile", "error");
          }
        }
      });
    };
    
    window.changePassword = function() {
      const currentPassword = document.getElementById("currentPassword").value;
      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const message = document.getElementById("securityMessage");
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage(message, "Please fill all fields", "error");
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showMessage(message, "New passwords don't match", "error");
        return;
      }
      
      if (newPassword.length < 6) {
        showMessage(message, "Password must be at least 6 characters", "error");
        return;
      }
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            // In a real app, you would reauthenticate first
            await updatePassword(user, newPassword);
            showMessage(message, "Password changed successfully", "success");
            
            // Clear fields
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";
          } catch (error) {
            console.error("Error changing password:", error);
            showMessage(message, error.message, "error");
          }
        }
      });
    };
    
    window.savePreferences = function() {
      const language = document.getElementById("language").value;
      const currency = document.getElementById("currency").value;
      const message = document.getElementById("preferencesMessage");
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const updates = {
              preferences: {
                language,
                currency
              }
            };
            
            await update(ref(db, `users/${user.uid}`), updates);
            showMessage(message, "Preferences saved successfully", "success");
          } catch (error) {
            console.error("Error saving preferences:", error);
            showMessage(message, "Failed to save preferences", "error");
          }
        }
      });
    };
    
    window.generateNewEmei = function() {
      // Generate a random 10-digit number for the EMEI
      const newEmei = Math.floor(1000000000 + Math.random() * 9000000000).toString();
      document.getElementById("shopEmei").value = newEmei;
    };
    
    window.saveCustomerAccessSettings = function() {
      const shopEmei = document.getElementById("shopEmei").value.trim();
      const message = document.getElementById("customerAccessMessage");
      
      if (!shopEmei) {
        showMessage(message, "Shop EMEI is required", "error");
        return;
      }
      
      if (!/^\d{10}$/.test(shopEmei)) {
        showMessage(message, "EMEI must be a 10-digit number", "error");
        return;
      }
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const updates = {
              shop_emei: shopEmei
            };
            
            await update(ref(db, `users/${user.uid}`), updates);
            showMessage(message, "Customer access settings saved successfully", "success");
          } catch (error) {
            console.error("Error saving customer access settings:", error);
            showMessage(message, "Failed to save settings", "error");
          }
        }
      });
    };
    
    function showMessage(element, text, type) {
      element.textContent = text;
      element.className = `message ${type}`;
      element.style.display = "block";
      
      setTimeout(() => {
        element.style.display = "none";
      }, 5000);
    }
  </script>
</body>
</html>